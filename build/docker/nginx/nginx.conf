worker_processes auto;
events { worker_connections 1024; }
http {
  include       mime.types;
  sendfile      on;
  resolver      127.0.0.11 ipv6=off;

  # Origem permitida (adicione outras linhas no map se precisar)
  map $http_origin $cors_origin {
    default "";
    "~^http://localhost:5173$" $http_origin;
  }

  # Upstreams: use a PORTA INTERNA dos containers
  upstream api_main    { server desafio.fluxocaixa.api:8080; }
  upstream api_reports { server desafio.fluxocaixa.relatorios.api:8080; }

  server {
    listen 80;

    set $cors_methods "GET,POST,PUT,PATCH,DELETE,OPTIONS";
    set $cors_headers "Authorization,Content-Type,Accept,Origin,Referer,User-Agent";

    proxy_connect_timeout   3s;
    proxy_send_timeout      30s;
    proxy_read_timeout      30s;

    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Methods;

    # ---- Relat√≥rios ----
    location /api/v1/relatorios/ {
      # Preflight no Nginx
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin  $cors_origin always;
        add_header Access-Control-Allow-Methods $cors_methods always;
        add_header Access-Control-Allow-Headers $cors_headers always;
        add_header Access-Control-Max-Age 86400 always;
        add_header Vary Origin always;
        return 204;
      }

      proxy_pass http://api_reports/api/v1/relatorios/;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization     $http_authorization;

      add_header Access-Control-Allow-Origin  $cors_origin always;
      add_header Vary Origin always;
    }

    # ---- API principal ----
    location /api/ {
      # Preflight no Nginx
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin  $cors_origin always;
        add_header Access-Control-Allow-Methods $cors_methods always;
        add_header Access-Control-Allow-Headers $cors_headers always;
        add_header Access-Control-Max-Age 86400 always;
        add_header Vary Origin always;
        return 204;
      }

      proxy_pass http://api_main;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization     $http_authorization;

      # CORS nas respostas proxied
      add_header Access-Control-Allow-Origin  $cors_origin always;
      add_header Vary Origin always;
    }
  }
}
